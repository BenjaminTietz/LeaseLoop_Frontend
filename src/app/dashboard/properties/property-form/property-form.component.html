<main>
  <form [formGroup]="propertyForm" [appClickOutside]="closeForm">
    @if(propertyService.sending()) {
    <app-progress-bar aria-label="Loading"></app-progress-bar>
    }
    <mat-icon aria-label="Close" class="close-icon" (click)="closeForm()">close</mat-icon>
    @if(propertyService.selectedProperty() === null) {
    <h1>New Property</h1>
    }
    @if(propertyService.selectedProperty() !== null) {
    <h1>Edit Property</h1>
    }
    <div class="form-field">
      <input type="text" id="name" name="name" required placeholder="Name" formControlName="name">
      @if(formService.getFormErrors(propertyForm, 'name')?.['required']) {
      <small>Name is required</small>
      }
    </div>
    <div class="form-field">
      <input type="text" id="address" name="address" required placeholder="Address" formControlName="address">
      @if(formService.getFormErrors(propertyForm, 'address')?.['required']) {
      <small>Address is required</small>
      }
    </div>
    <div class="textarea-field">
      <textarea type="text" id="description" name="description" required placeholder="Description"
        formControlName="description"></textarea>
      @if(formService.getFormErrors(propertyForm, 'description')?.['required']) {
      <small>Description is required</small>
      }
    </div>
    <div class="form-field">
      <input type="file" id="image" name="image" accept="image/*" multiple hidden (change)="onImageChange($event)">
      <label for="image" class="upload-button">
        <mat-icon>drive_folder_upload</mat-icon>
        <span>Upload images</span>
      </label>
    </div>
    @if(propertyService.selectedProperty() === null && imagePreviews.length > 0) {
      <div class="image-field">
        @for(preview of imagePreviews; track $index) {
          <div class="image">
            <img [src]="preview" alt="Selected image preview" />
            <mat-icon (click)="removePreview(preview)" aria-label="Delete">delete</mat-icon>
            <textarea
              type="text"
              placeholder="Image description"
              required
              [value]="newImageDescriptions[$index]"
              #descInput
              (input)="newImageDescriptions[$index] = descInput.value" ></textarea>
          </div>
        }
        @if(hasMissingDescriptions()) {
          <small>Please provide a description for every image before saving.</small>
        }
      </div>
    }

    @if(propertyService.selectedProperty() !== null) {
      @if(propertyService.selectedProperty()?.images?.length || imagePreviews.length > 0){

     
    <div class="image-field">
      @for(image of propertyService.selectedProperty()?.images; track image.id) {
      <div class="image">
        <img [src]="'http://localhost:8000' + image.image" alt="property image" />
        <mat-icon (click)="deleteImage(image.id)" aria-label="Delete">delete</mat-icon>
        <textarea type="text" placeholder="Image description" required [value]="image.alt_text || ''" #descInput
          (input)="updateExistingImageDescription(image.id, descInput.value)"></textarea>
      </div>
      }
      @if(imagePreviews.length > 0) {
      @for(preview of imagePreviews; track $index) {
      <div class="image">
        <img [src]="preview" alt="Selected image preview" />
        <mat-icon (click)="removePreview(preview)" aria-label="Delete">delete</mat-icon>
        <textarea type="text" placeholder="Image description" required [value]="newImageDescriptions[$index]" #previewInput
          (input)="newImageDescriptions[$index] = previewInput.value" ></textarea>
      </div>
      }
      }
      @if(hasMissingDescriptions()) {
        <small>Please provide a description for every image before updating.</small>
      }
    </div>
    }
    
    }
    <div class="button-area">
      @if(propertyService.selectedProperty() !== null) {
      <button type="button" (click)="deleteProperty()">Delete</button>
      <button type="submit" (click)="updateProperty()"
        [disabled]="propertyForm.invalid || propertyService.sending() || hasMissingDescriptions()">
        Update
      </button>
      }
      @if(propertyService.selectedProperty() === null) {
      <button type="submit" (click)="createProperty()"
        [disabled]="propertyForm.invalid || propertyService.sending() || hasMissingDescriptions()">
        Save
      </button>
      }
    </div>
  </form>
</main>