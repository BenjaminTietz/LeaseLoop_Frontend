<main>
  <form [formGroup]="bookingForm" [appClickOutside]="closeForm" (ngSubmit)="submitForm()">
    @if(bookingService.sending()) {
    <app-progress-bar aria-label="Loading"></app-progress-bar>
    }
    <mat-icon aria-label="Close" class="close-icon" (click)="closeForm()">close</mat-icon>
    @if(bookingService.selectedBooking() === null) {
    <h1>New Booking</h1>
    }
    @if(bookingService.selectedBooking() !== null) {
    <h1>Edit Booking</h1>
    }

    <div class="input-area">
      <label for="check_in">Check In</label>
      <div class="form-field">
        <input type="date" min="{{minCheckInDate}}" id="check_in" name="check_in" formControlName="check_in"
          (change)="setMinCheckOutDate($any($event.target).value)" required>
      </div>
    </div>
    @if(!showCheckOutInput()) {
      <p class="info-text">Please select a check-in date.</p>
    }
    @if(showCheckOutInput()) {

    <div class="input-area">
      <label for="check_out">Check Out</label>
      <div class="form-field">
        <input type="date" min="{{minCheckOutDate}}" id="check_out" name="check_out" formControlName="check_out"
          required (change)="checkIn() && filterAvailableProperties(checkIn()!, $any($event.target).value)">
      </div>
    </div>
    }
    @if(checkIn()) {
      @if(!bookingForm.get('check_out')?.value) {
        <p class="info-text">Now select a check-out date to see available properties.</p>
      }
    }
    

    @if(showPropertyInput()) {
    <div class="input-area">
      <label for="property">Property</label>
      <div class="form-field">
        <select id="property" name="property" formControlName="property"
          (change)="onPropertyChange(bookingForm.value.property)">
          <option [ngValue]="null" disabled>Select Property</option>
          @for(property of availableProperties(); track $index) {
          <option [ngValue]="property.id">{{ property.name }}</option>
          }
        </select>
      </div>
    </div>
    }
    @if(checkIn() && checkOut() && availableProperties().length === 0) {
      <p class="info-text">No available properties for the selected dates.</p>
      <button routerLink="/dashboard">Check availability calendar</button>
    }
    


    @if(showUnitInput()) {
    <div class="input-area">
      <label for="unit">Unit</label>
      <div class="form-field">
        <select id="unit" name="unit" formControlName="unit" (change)="onUnitChange($any($event.target).value)">
          <option [ngValue]="null" disabled>Select Unit</option>
          @for(unit of availableUnits(); track $index) {
          <option [ngValue]="unit.id">{{ unit.name }}</option>
          }
        </select>
      </div>
    </div>
    }

    @if(showUnitInput() && bookingForm.get('unit')?.value === null && availableUnits().length > 0) {
      <p class="info-text">Please select a unit.</p>
    }

    @if(showGuestsInput()) {
      <div class="input-area">
        <label for="guests_count">Guests count</label>
        <div class="form-field">
          <input type="number" min="1" id="guests_count" name="guests_count" required placeholder="Guests conunt"
            (change)="onGuestsCountChange($any($event.target).value)" formControlName="guests_count"
            (input)="onGuestsCountChange($any($event.target).value)">
        </div>
      </div>
      @if(showGuestsInput() && !bookingForm.get('guests_count')?.value) {
        <small>Please enter the number of guests.</small>
      }
      
      @if(guestCountExceedsCapacity()) {
        <small>Selected unit cannot accommodate this number of guests.</small>
      }
    }
   
      
    @if(showRestOfForm()) {


    <div class="input-area">
      <label for="client">Client</label>
      <div class="form-field">
        <select id="client" name="client" formControlName="client">
          <option [ngValue]="null" disabled>Select Customer</option>
          @for(client of clientService.clients(); track $index) {
          <option [ngValue]="client.id">{{client.first_name}} {{client.last_name}}</option>
          }
        </select>
      </div>
    </div>


    <div class="input-area">
      <label for="deposit_paid">Deposit Paid</label>
      <div class="form-field">
        <select name="deposit_paid" id="deposit_paid" formControlName="deposit_paid">
          <option [ngValue]="true">Yes</option>
          <option [ngValue]="false">No</option>
        </select>
      </div>
    </div>

    @if(bookingForm.get('deposit_paid')?.value === true) {
    <div class="input-area">
      <label for="deposit_amount">Deposit Amount</label>
      <div class="form-field">
        <input type="number" id="deposit_amount" name="deposit_amount" required placeholder="Deposit Amount"
          formControlName="deposit_amount">
      </div>
    </div>
    }

    <div class="input-area">
      <label for="status">Status</label>
      <div class="form-field">
        <select name="status" id="status" formControlName="status">
          <option [ngValue]="'pending'">Pending</option>
          <option [ngValue]="'confirmed'">Confirmed</option>
          <option [ngValue]="'cancelled'">Cancelled</option>
        </select>
      </div>
    </div>

    <div class="input-area">
      <label for="promo_code">Promo code</label>
      <div class="form-field">
        <select name="promo_code" id="promo_code" formControlName="promo_code">
          <option [ngValue]="null" disabled>Select Promo Code</option>
          @for(promocode of promoService.promocodes(); track $index) {
          <option [ngValue]="promocode.id">{{promocode.description}} {{promocode.discount_percent}}%</option>
          }
        </select>
      </div>
    </div>

    <div class="input-area" formGroupName="services">
      <label for="service">Services</label>
      @for(service of serviceService.services(); track $index){
      <div class="form-field">
        <div class="checkbox-list">
          <input type="checkbox" [value]="service.id" (change)="onServiceChange($event, service.id)"
            [checked]="bookingForm.value.services?.includes(service.id)">
          <span>{{ service.name }}</span>
        </div>
      </div>
      }
    </div>



    <button type="submit" [disabled]="!bookingForm.valid">Test</button>
    }
  </form>
</main>